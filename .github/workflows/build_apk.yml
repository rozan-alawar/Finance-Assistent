name: Build Mobile Apps

on:
  push:
    branches: [main, staging]
  workflow_dispatch:  # manual trigger

# Cancel previous runs if new push comes
concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: '3.29.1'

jobs:
  # ============================================
  # Job 1: Build Android APK
  # ============================================
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('*/.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-


      - name: Cache Android SDK
        uses: actions/cache@v4
        with:
          path: |
            /usr/local/lib/android/sdk/ndk
            /usr/local/lib/android/sdk/build-tools
            /usr/local/lib/android/sdk/platforms
          key: android-sdk-${{ runner.os }}-ndk28
          restore-keys: |
            android-sdk-${{ runner.os }}-        


      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      - name: Cache pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            pub-${{ runner.os }}-

      - name: Accept Android licenses
        run: |
          yes | sdkmanager --licenses || true
          yes | flutter doctor --android-licenses || true       

      - name: Get dependencies
        run: flutter pub get

      - name: Decode Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/upload-keystore.jks

      - name: Create key.properties
        run: |
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
          echo "storeFile=upload-keystore.jks" >> android/key.properties

      - name: Build signed APK
        run: flutter build apk --release --split-per-abi



      # Upload APK as artifact (downloadable from GitHub)
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-${{ github.ref_name }}
          path: build/app/outputs/flutter-apk/*.apk
          retention-days: 14

      # ============================================
      # Job 2: Build iOS IPA
      # ============================================
      # build-ios:
      #   name: Build iOS IPA
      #   runs-on: macos-latest

      #   steps:
      #     - name: Checkout code
      #       uses: actions/checkout@v4

      #     - name: Setup Flutter
      #       uses: subosito/flutter-action@v2
      #       with:
      #         flutter-version: ${{ env.FLUTTER_VERSION }}
      #         cache: true

      #     - name: Get dependencies
      #       run: flutter pub get

      #     - name: Install CocoaPods dependencies
      #       run: |
      #         cd ios
      #         pod install

      #     # Build without code signing (for testing/distribution via other means)
      #     - name: Build iOS (no codesign)
      #       run: flutter build ios --release --no-codesign

      #     # Create IPA from the app bundle
      #     - name: Create IPA
      #       run: |
      #         mkdir -p build/ios/ipa
      #         cd build/ios/iphoneos
      #         mkdir Payload
      #         cp -r Runner.app Payload/
      #         zip -r ../ipa/app-release.ipa Payload

  #     - name: Upload IPA
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: ios-ipa-${{ github.ref_name }}
  #         path: build/ios/ipa/app-release.ipa
  #         retention-days: 14

  # ============================================
  # Job 3: Send to Telegram (optional - runs after builds)
  # ============================================
  notify-telegram:
    name: Send to Telegram
    runs-on: ubuntu-latest
    needs: [build-android]  # wait for both builds

    steps:
      - name: Download Android APK
        uses: actions/download-artifact@v4
        with:
          name: android-apk-${{ github.ref_name }}
          path: artifacts/android

      # - name: Download iOS IPA
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: ios-ipa-${{ github.ref_name }}
      #     path: artifacts/ios

      - name: Send APK to Telegram
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            üöÄ New Build from ${{ github.repository }}
            
            üìå Branch: ${{ github.ref_name }}
            üìù Commit: ${{ github.event.head_commit.message }}
            üë§ Author: ${{ github.actor }}
            üîó Commit: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}
            üì¶ Download APK & IPA:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          document: artifacts/android/app-arm64-v8a-release.apk
      # - name: Send IPA to Telegram
      #   uses: appleboy/telegram-action@master
      #   with:
      #     to: ${{ secrets.TELEGRAM_CHAT_ID }}
      #     token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      #     message: |
      #       üì± iOS Build
      #     document: artifacts/ios/app-release.ipa