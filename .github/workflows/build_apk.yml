name: Build Mobile Apps

on:
  push:
    branches:
      - ci-branch
  workflow_dispatch:

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # Job 1: Build Android APK
  # ============================================
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # âœ… Ù†Ø³ØªØ®Ø¯Ù… Ø£Ø­Ø¯Ø« stable Ø¨Ø¯Ù„ Ø±Ù‚Ù… Ù†Ø³Ø®Ø© Ø«Ø§Ø¨Øª
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            pub-${{ runner.os }}-

      - name: Accept Android licenses
        run: yes | flutter doctor --android-licenses || true

      - name: Get dependencies
        run: flutter pub get

      - name: Decode Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/upload-keystore.jks

      - name: Create key.properties
        run: |
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
          echo "storeFile=upload-keystore.jks" >> android/key.properties

      - name: Build signed APK
        run: flutter build apk --release --split-per-abi

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-${{ github.ref_name }}
          path: build/app/outputs/flutter-apk/*.apk
          retention-days: 14

  # ============================================
  # Job 2: Send to Telegram
  # ============================================
  notify-telegram:
    name: Send to Telegram
    runs-on: ubuntu-latest
    needs: [build-android]

    steps:
      - name: Download Android APK
        uses: actions/download-artifact@v4
        with:
          name: android-apk-${{ github.ref_name }}
          path: artifacts/android

      - name: Send APK to Telegram
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ğŸš€ New Build from ${{ github.repository }}
            
            ğŸ“Œ Branch: ${{ github.ref_name }}
            ğŸ“ Commit: ${{ github.event.head_commit.message }}
            ğŸ‘¤ Author: ${{ github.actor }}
            ğŸ”— Commit: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}
            
            ğŸ“¦ Download from GitHub:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          document: artifacts/android/app-arm64-v8a-release.apk
